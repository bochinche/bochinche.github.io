<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Impostor Word Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.4;
    }
    body {
      margin: 0;
      padding: 1.5rem;
      background: #111111;          /* dark grey background */
      color: #e5e7eb;
    }
    h1, h2, h3 {
      margin-top: 0;
      color: #f9fafb;
    }
    .card {
      background: #1e1e1e;          /* dark grey cards */
      border-radius: 0.75rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #111111;
      color: #e5e7eb;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid #6366f1;
      outline-offset: 1px;
      border-color: #6366f1;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      background: #6366f1;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    button.secondary {
      background: #374151;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 160px;
    }
    .player-links {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .player-card {
      border-radius: 0.75rem;
      border: 1px solid #374151;
      padding: 0.75rem;
      background: #101010;
      font-size: 0.9rem;
    }
    .player-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .small {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .word-display {
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      margin: 1.5rem 0 0.5rem;
    }
    .tagline {
      font-size: 0.85rem;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 0.75rem;
    }
    .highlight {
      color: #facc15;
    }
    .impostor {
      color: #f97316;
      font-size: 2rem;
    }
    .center {
      text-align: center;
    }
    a {
      color: #a5b4fc;
      word-break: break-all;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .badge {
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #4b5563;
      color: #e5e7eb;
      display: inline-block;
      margin-bottom: 0.25rem;
    }
    img.qr {
      display: block;
      margin-top: 0.5rem;
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      background: white;
      padding: 0.25rem;
    }
    ul {
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
      padding-left: 1.2rem;
    }
    @media (min-width: 720px) {
      body {
        max-width: 840px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // --- Local fallback word lists ---
    const WORDS = {
      es: [
        "aeropuerto", "paraguas", "pizza", "guitarra", "monta√±a",
        "cine", "m√©dico", "volc√°n", "caf√©", "bicicleta",
        "playa", "avi√≥n", "f√∫tbol", "nevera", "ordenador",
        "ventana", "biblioteca", "hotel", "robot", "sat√©lite"
      ],
      en: [
        "airport", "umbrella", "pizza", "guitar", "mountain",
        "cinema", "doctor", "volcano", "coffee", "bicycle",
        "beach", "airplane", "football", "fridge", "computer",
        "window", "library", "hotel", "robot", "satellite"
      ],
      de: [
        "Flughafen", "Regenschirm", "Pizza", "Gitarre", "Berg",
        "Kino", "Arzt", "Vulkan", "Kaffee", "Fahrrad",
        "Strand", "Flugzeug", "Fu√üball", "K√ºhlschrank", "Computer",
        "Fenster", "Bibliothek", "Hotel", "Roboter", "Satellit"
      ]
    };

    function randomLocalWord(lang) {
      const list = WORDS[lang] || WORDS["es"];
      return list[Math.floor(Math.random() * list.length)];
    }

    // --- Online word fetch: Random Word API with language support ---
    async function fetchRandomWordOnline(lang) {
      let apiLang = "";
      if (lang === "es") apiLang = "es";
      else if (lang === "de") apiLang = "de"; // attempt German
      // default EN if empty

      let url = "https://random-word-api.herokuapp.com/word?number=1";
      if (apiLang) {
        url += "&lang=" + encodeURIComponent(apiLang);
      }

      try {
        const resp = await fetch(url, { cache: "no-store" });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        let word = "";

        if (Array.isArray(data) && data.length > 0) {
          word = String(data[0]);
        } else if (data && typeof data.word === "string") {
          word = data.word;
        }

        if (!word) throw new Error("Empty word");
        return word.trim();
      } catch (e) {
        console.error("Random word API failed, fallback to local:", e);
        return randomLocalWord(lang);
      }
    }

    function randomInt(max) {
      return Math.floor(Math.random() * max);
    }

    function createGameId() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let id = "";
      for (let i = 0; i < 5; i++) {
        id += chars[Math.floor(Math.random() * chars.length)];
      }
      return id;
    }

    // Encode/decode payload (UTF-8 safe) -> base64
    function encodePayload(obj) {
      const json = JSON.stringify(obj);
      return btoa(unescape(encodeURIComponent(json)));
    }

    function decodePayload(b64) {
      const json = decodeURIComponent(escape(atob(b64)));
      return JSON.parse(json);
    }

    // Simple i18n helper
    function t(lang, es, en, de) {
      if (lang === "es") return es;
      if (lang === "de") return de;
      return en; // default English
    }

    // Fair impostor counts across rounds (per browser session)
    let impostorCounts = null;

    function render() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("t");

      if (token) {
        try {
          const payload = decodePayload(token);
          renderPlayerView(payload);
        } catch (e) {
          console.error("Invalid token payload", e);
          document.getElementById("app").innerHTML = `
            <div class="card">
              <h1>Error</h1>
              <p class="small">
                Enlace/Link ung√ºltig. Pide al anfitri√≥n / Bitte den Host um einen neuen Code.
              </p>
            </div>
          `;
        }
      } else {
        renderHostView();
      }
    }

    function renderPlayerView(payload) {
      const { l: lang = "es", p, r, n, w } = payload;
      const app = document.getElementById("app");

      const displayName =
        n ||
        (p !== undefined
          ? t(lang,
              "Jugador #" + (parseInt(p, 10) + 1),
              "Player #" + (parseInt(p, 10) + 1),
              "Spieler #" + (parseInt(p, 10) + 1)
            )
          : t(lang, "Jugador", "Player", "Spieler"));

      const isImpostor = r === "I";

      app.innerHTML = `
        <div class="card">
          <span class="badge">${t(lang, "Vista jugador", "Player view", "Spielansicht")}</span>
          <h1>${t(lang, "Impostor", "Impostor", "Impostor")}</h1>
          <p class="tagline">
            ${t(
              lang,
              "No ense√±es esta pantalla a nadie.",
              "Don‚Äôt show this screen to anyone.",
              "Zeige diesen Bildschirm niemandem."
            )}
          </p>
          <div class="center small">
            ${displayName}
          </div>

          <div class="word-display">
            ${
              isImpostor
                ? `<span class="impostor">${t(
                    lang,
                    "ERES EL IMPOSTOR",
                    "YOU ARE THE IMPOSTOR",
                    "DU BIST DER IMPOSTOR"
                  )}</span>`
                : `<span>${t(lang, "Tu palabra:", "Your word:", "Dein Wort:")}</span><br>
                   <span class="highlight">${w || "??"}</span>`
            }
          </div>

          <div class="card" style="margin-top:1.25rem;">
            <h3>${t(lang, "Siguiente paso", "Next step", "N√§chster Schritt")}</h3>
            <p class="small">
              ${t(
                lang,
                "El anfitri√≥n dirigir√° la ronda de pistas y la votaci√≥n. Los jugadores con palabra deben dar pistas sin decirla directamente. El impostor intentar√° mezclarse sin conocer la palabra.",
                "The host will lead the clue round and voting. Players with the word give subtle clues without saying it directly. The impostor will try to blend in without knowing the word.",
                "Der Host leitet die Hinweisrunde und die Abstimmung. Spieler mit dem Wort geben subtile Hinweise, ohne es direkt zu nennen. Der Impostor versucht mitzuhalten, ohne das Wort zu kennen."
              )}
            </p>
          </div>
        </div>
      `;
    }

    function renderHostView() {
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="card">
          <span class="badge">Host</span>
          <h1>Impostor Word Game</h1>
          <p class="tagline">
            Crea una sesi√≥n, define los nombres de los jugadores y genera un c√≥digo QR
            para cada uno. N-1 ver√°n la palabra, 1 ver√° ‚ÄúIMPOSTOR‚Äù.
            Die W√∂rter k√∂nnen auf Spanisch, Englisch oder Deutsch sein.
          </p>
        </div>

        <div class="card">
          <h2>C√≥mo jugar / How to play / Spielanleitung</h2>
          <h3>Espa√±ol</h3>
          <ul>
            <li>El anfitri√≥n escribe los nombres de todos los jugadores.</li>
            <li>La app elige una palabra secreta y un impostor.</li>
            <li>Cada jugador escanea su c√≥digo QR:
              <ul>
                <li>Jugadores normales ven la palabra.</li>
                <li>El impostor solo ve que es el impostor, sin palabra.</li>
              </ul>
            </li>
            <li>Por turnos, cada jugador da una pista corta sobre la palabra.</li>
            <li>Tras una o dos rondas de pistas, todos votan qui√©n creen que es el impostor.</li>
            <li>El anfitri√≥n revela qui√©n era el impostor y la palabra secreta.</li>
          </ul>

          <h3>English</h3>
          <ul>
            <li>The host enters all player names.</li>
            <li>The app chooses a secret word and one impostor.</li>
            <li>Each player scans their QR code:
              <ul>
                <li>Normal players see the secret word.</li>
                <li>The impostor only sees they are the impostor, no word.</li>
              </ul>
            </li>
            <li>In turns, each player gives a short clue about the word.</li>
            <li>After one or two clue rounds, everyone votes who they think is the impostor.</li>
            <li>The host reveals the impostor and the secret word.</li>
          </ul>

          <h3>Deutsch</h3>
          <ul>
            <li>Der Host tr√§gt alle Spielernamen ein.</li>
            <li>Die App w√§hlt ein geheimes Wort und einen Impostor.</li>
            <li>Jeder Spieler scannt seinen QR-Code:
              <ul>
                <li>Normale Spieler sehen das geheime Wort.</li>
                <li>Der Impostor sieht nur, dass er Impostor ist ‚Äì ohne Wort.</li>
              </ul>
            </li>
            <li>Reihum gibt jeder Spieler einen kurzen Hinweis zum Wort.</li>
            <li>Nach ein bis zwei Runden Hinweise stimmen alle ab, wer der Impostor ist.</li>
            <li>Der Host deckt den Impostor und das geheime Wort auf.</li>
          </ul>
        </div>

        <div class="card">
          <h2>Configuraci√≥n de la sesi√≥n</h2>
          <div class="row">
            <div>
              <label for="language">Idioma / Sprache</label>
              <select id="language">
                <option value="es">Espa√±ol</option>
                <option value="en">English</option>
                <option value="de">Deutsch</option>
              </select>
            </div>
            <div>
              <label for="customWord">Palabra / Wort (opcional)</label>
              <input id="customWord" type="text" placeholder="vac√≠o = palabra aleatoria / empty = random word" />
            </div>
          </div>

          <div style="margin-top:0.75rem;">
            <label for="playerNames">
              Nombres / Namen de los jugadores (uno por l√≠nea / eine Zeile pro Spieler, m√≠nimo 3)
            </label>
            <textarea id="playerNames"
              placeholder="Ejemplo / Beispiel:
Antonio
Mar√≠a
Carlos
..."></textarea>
          </div>

          <div style="margin-top:1rem;">
            <button id="btnNewSession">
              üÉè Crear nueva sesi√≥n
            </button>
            <button id="btnReveal" class="secondary" disabled>
              üëÄ Revelar impostor y palabra
            </button>
          </div>

          <div id="sessionInfo" class="small" style="margin-top:0.75rem; color:#9ca3af;"></div>
        </div>

        <div class="card">
          <h2>C√≥digos QR para los jugadores</h2>
          <p class="small">
            Despu√©s de crear una sesi√≥n, se mostrar√°n aqu√≠ los c√≥digos QR.
            Cada jugador escanea s√≥lo su propio c√≥digo con el m√≥vil.
          </p>
          <div id="playerLinks" class="player-links"></div>
        </div>
      `;

      const btnNewSession = document.getElementById("btnNewSession");
      const btnReveal = document.getElementById("btnReveal");
      const languageSelect = document.getElementById("language");
      const customWordInput = document.getElementById("customWord");
      const namesTextarea = document.getElementById("playerNames");
      const sessionInfo = document.getElementById("sessionInfo");
      const playerLinksContainer = document.getElementById("playerLinks");

      let currentSession = null;

      btnNewSession.addEventListener("click", async () => {
        const rawNames = namesTextarea.value
          .split("\n")
          .map(s => s.trim())
          .filter(s => s.length > 0);

        if (rawNames.length < 3) {
          alert(
            "Introduce al menos 3 nombres de jugadores (uno por l√≠nea).\n" +
            "Bitte mindestens 3 Spielernamen (eine Zeile pro Spieler) eingeben."
          );
          return;
        }

        const nPlayers = rawNames.length;
        const lang = languageSelect.value || "es";
        let word = customWordInput.value.trim();

        if (!word) {
          word = await fetchRandomWordOnline(lang);
        }

        const gameId = createGameId();

        // --- Fair impostor selection across rounds ---
        if (!impostorCounts || impostorCounts.length !== nPlayers) {
          impostorCounts = new Array(nPlayers).fill(0);
        }
        const minCount = Math.min(...impostorCounts);
        const candidates = [];
        for (let i = 0; i < nPlayers; i++) {
          if (impostorCounts[i] === minCount) {
            candidates.push(i);
          }
        }
        const impostorIndex = candidates[randomInt(candidates.length)];
        impostorCounts[impostorIndex]++;

        currentSession = {
          gameId,
          lang,
          word,
          nPlayers,
          impostorIndex,
          playerNames: rawNames
        };

        const baseUrl = window.location.origin + window.location.pathname;

        playerLinksContainer.innerHTML = "";
        for (let i = 0; i < nPlayers; i++) {
          const isImpostor = i === impostorIndex;
          const playerName = rawNames[i];

          const payload = {
            v: 1,
            w: word,              // word
            l: lang,              // language
            p: i,                 // player index
            r: isImpostor ? "I" : "N", // role
            n: playerName
          };

          const token = encodePayload(payload);
          const link = `${baseUrl}?t=${encodeURIComponent(token)}`;
          const qrUrl =
            "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" +
            encodeURIComponent(link);

          const div = document.createElement("div");
          div.className = "player-card";
          div.innerHTML = `
            <div class="player-title">
              ${playerName} <span class="small">(Jugador/Spieler #${i + 1})</span>
            </div>
            <div class="small">Escanea / Scannen:</div>
            <img class="qr" src="${qrUrl}" alt="QR para ${playerName}" />
            <div class="small" style="margin-top:0.35rem;">
              Si el QR falla, abre este enlace / Wenn der QR-Code nicht funktioniert, diesen Link √∂ffnen:<br>
              <a href="${link}" target="_blank">${link}</a>
            </div>
          `;
          playerLinksContainer.appendChild(div);
        }

        sessionInfo.textContent =
          `ID sesi√≥n / Session-ID: ${gameId} ¬∑ Jugadores/Spieler: ${nPlayers}`;
        btnReveal.disabled = false;
      });

      btnReveal.addEventListener("click", () => {
        if (!currentSession) return;
        const name = currentSession.playerNames[currentSession.impostorIndex];
        alert(
          `El impostor es / Der Impostor ist: ${name} ` +
          `(jugador/Spieler #${currentSession.impostorIndex + 1})\n` +
          `Palabra secreta / Geheimes Wort: ‚Äú${currentSession.word}‚Äù`
        );
      });
    }

    render();
  </script>
</body>
</html>