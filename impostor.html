<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Impostor Word Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.4;
    }
    body {
      margin: 0;
      padding: 1.5rem;
      background: #111827;
      color: #e5e7eb;
    }
    h1, h2, h3 {
      margin-top: 0;
      color: #f9fafb;
    }
    .card {
      background: #1f2937;
      border-radius: 0.75rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid #6366f1;
      outline-offset: 1px;
      border-color: #6366f1;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      background: #6366f1;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    button.secondary {
      background: #374151;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 160px;
    }
    .player-links {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .player-card {
      border-radius: 0.75rem;
      border: 1px solid #374151;
      padding: 0.75rem;
      background: #0f172a;
      font-size: 0.9rem;
    }
    .player-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .small {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .word-display {
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      margin: 1.5rem 0 0.5rem;
    }
    .tagline {
      font-size: 0.85rem;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 0.75rem;
    }
    .impostor {
      color: #f97316;
      font-size: 2rem;
    }
    .center {
      text-align: center;
    }
    a {
      color: #a5b4fc;
      word-break: break-all;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .badge {
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #4b5563;
      color: #e5e7eb;
      display: inline-block;
      margin-bottom: 0.25rem;
    }
    img.qr {
      display: block;
      margin-top: 0.5rem;
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      background: white;
      padding: 0.25rem;
    }
    @media (min-width: 720px) {
      body {
        max-width: 840px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // --- Local fallback word lists ---
    const WORDS = {
      es: [
        "aeropuerto", "paraguas", "pizza", "guitarra", "monta√±a",
        "cine", "m√©dico", "volc√°n", "caf√©", "bicicleta",
        "playa", "avi√≥n", "f√∫tbol", "nevera", "ordenador",
        "ventana", "biblioteca", "hotel", "robot", "sat√©lite"
      ],
      en: [
        "airport", "umbrella", "pizza", "guitar", "mountain",
        "cinema", "doctor", "volcano", "coffee", "bicycle",
        "beach", "airplane", "football", "fridge", "computer",
        "window", "library", "hotel", "robot", "satellite"
      ]
    };

    function randomLocalWord(lang) {
      const list = WORDS[lang] || WORDS["es"];
      return list[Math.floor(Math.random() * list.length)];
    }

    // --- Online word fetch: Random Word API with language support ---
    // Docs: https://random-word-api.herokuapp.com/home
    async function fetchRandomWordOnline(lang) {
      // Map our UI language to API lang code
      const apiLang =
        lang === "es" ? "es" :
        lang === "en" ? "" : ""; // default is English

      let url = "https://random-word-api.herokuapp.com/word?number=1";
      if (apiLang) {
        url += "&lang=" + encodeURIComponent(apiLang);
      }

      try {
        const resp = await fetch(url, { cache: "no-store" });
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();
        let word = "";

        if (Array.isArray(data) && data.length > 0) {
          word = String(data[0]);
        } else if (data && typeof data.word === "string") {
          word = data.word;
        }

        if (!word) {
          throw new Error("Empty word from API");
        }

        // Normalise / trim
        return word.trim();
      } catch (e) {
        console.error("Random word API failed, falling back to local list:", e);
        return randomLocalWord(lang);
      }
    }

    function randomInt(max) {
      return Math.floor(Math.random() * max);
    }

    function createGameId() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let id = "";
      for (let i = 0; i < 5; i++) {
        id += chars[Math.floor(Math.random() * chars.length)];
      }
      return id;
    }

    function render() {
      const urlParams = new URLSearchParams(window.location.search);
      const role = urlParams.get("role");
      const lang = urlParams.get("lang") || "es";
      const playerIndex = urlParams.get("p");
      const impostorFlag = urlParams.get("imp") === "1";
      const playerName = urlParams.get("name") || "";

      if (role === "player") {
        renderPlayerView({ lang, playerIndex, impostorFlag, playerName });
      } else {
        renderHostView();
      }
    }

    function renderPlayerView({ lang, playerIndex, impostorFlag, playerName }) {
      const app = document.getElementById("app");
      const isEs = lang === "es";

      const displayName =
        playerName ||
        (playerIndex !== null
          ? (isEs ? "Jugador" : "Player") + " #" + (parseInt(playerIndex, 10) + 1)
          : isEs ? "Jugador" : "Player");

      app.innerHTML = `
        <div class="card">
          <span class="badge">${isEs ? "Vista jugador" : "Player view"}</span>
          <h1>${isEs ? "Impostor" : "Impostor"}</h1>
          <p class="tagline">
            ${isEs
              ? "No ense√±es esta pantalla a nadie."
              : "Don‚Äôt show this screen to anyone."
            }
          </p>
          <div class="center small">
            ${displayName}
          </div>

          <div class="word-display">
            ${
              impostorFlag
                ? `<span class="impostor">${isEs ? "ERES EL IMPOSTOR" : "YOU ARE THE IMPOSTOR"}</span>`
                : `<span>${isEs ? "Eres un jugador normal" : "You are a normal player"}</span>`
            }
          </div>

          <div class="card" style="margin-top:1.25rem;">
            <h3>${isEs ? "Siguiente paso" : "Next step"}</h3>
            <p class="small">
              ${
                isEs
                  ? "El anfitri√≥n dirigir√° la ronda de pistas y la votaci√≥n. El impostor intentar√° mezclarse. Al final se revelar√° qui√©n es el impostor y la palabra secreta."
                  : "The host will lead the clue round and voting. The impostor will try to blend in. At the end, the impostor and the secret word will be revealed."
              }
            </p>
          </div>
        </div>
      `;
    }

    function renderHostView() {
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="card">
          <span class="badge">Host</span>
          <h1>Impostor Word Game</h1>
          <p class="tagline">
            Crea una sesi√≥n, define los nombres de los jugadores y genera un c√≥digo QR
            para cada uno. N-1 ser√°n jugadores normales, 1 ser√° el impostor.
            La palabra se obtiene de internet (si es posible) y se revela s√≥lo al final.
          </p>
        </div>

        <div class="card">
          <h2>Configuraci√≥n de la sesi√≥n</h2>
          <div class="row">
            <div>
              <label for="language">Idioma de la palabra</label>
              <select id="language">
                <option value="es">Espa√±ol</option>
                <option value="en">English</option>
              </select>
            </div>
            <div>
              <label for="customWord">Palabra personalizada (opcional)</label>
              <input id="customWord" type="text" placeholder="d√©jalo vac√≠o para usar una palabra aleatoria de internet" />
            </div>
          </div>

          <div style="margin-top:0.75rem;">
            <label for="playerNames">
              Nombres de los jugadores (uno por l√≠nea, m√≠nimo 3)
            </label>
            <textarea id="playerNames"
              placeholder="Ejemplo:
Antonio
Mar√≠a
Carlos
..."></textarea>
          </div>

          <div style="margin-top:1rem;">
            <button id="btnNewSession">
              üÉè Crear nueva sesi√≥n
            </button>
            <button id="btnReveal" class="secondary" disabled>
              üëÄ Revelar impostor y palabra
            </button>
          </div>

          <div id="sessionInfo" class="small" style="margin-top:0.75rem; color:#9ca3af;"></div>
        </div>

        <div class="card">
          <h2>C√≥digos QR para los jugadores</h2>
          <p class="small">
            Despu√©s de crear una sesi√≥n, se mostrar√°n aqu√≠ los c√≥digos QR.
            Cada jugador escanea s√≥lo su propio c√≥digo con el m√≥vil.
          </p>
          <div id="playerLinks" class="player-links"></div>
        </div>
      `;

      const btnNewSession = document.getElementById("btnNewSession");
      const btnReveal = document.getElementById("btnReveal");
      const languageSelect = document.getElementById("language");
      const customWordInput = document.getElementById("customWord");
      const namesTextarea = document.getElementById("playerNames");
      const sessionInfo = document.getElementById("sessionInfo");
      const playerLinksContainer = document.getElementById("playerLinks");

      let currentSession = null;

      btnNewSession.addEventListener("click", async () => {
        const rawNames = namesTextarea.value
          .split("\n")
          .map(s => s.trim())
          .filter(s => s.length > 0);

        if (rawNames.length < 3) {
          alert("Introduce al menos 3 nombres de jugadores (uno por l√≠nea).");
          return;
        }

        const nPlayers = rawNames.length;
        const lang = languageSelect.value || "es";
        let word = customWordInput.value.trim();

        if (!word) {
          // Dynamic: try to get a word from the internet, fallback locally
          word = await fetchRandomWordOnline(lang);
        }

        const gameId = createGameId();
        const impostorIndex = randomInt(nPlayers);

        currentSession = {
          gameId,
          lang,
          word,
          nPlayers,
          impostorIndex,
          playerNames: rawNames
        };

        const baseUrl = window.location.origin + window.location.pathname;

        playerLinksContainer.innerHTML = "";
        for (let i = 0; i < nPlayers; i++) {
          const isImpostor = i === impostorIndex;
          const playerName = rawNames[i];

          const params = new URLSearchParams({
            role: "player",
            lang,
            p: String(i),
            imp: isImpostor ? "1" : "0",
            name: playerName
            // NO word param ‚Äî stays secret
          });

          const link = `${baseUrl}?${params.toString()}`;
          const qrUrl =
            "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" +
            encodeURIComponent(link);

          const div = document.createElement("div");
          div.className = "player-card";
          div.innerHTML = `
            <div class="player-title">
              ${playerName} <span class="small">(Jugador #${i + 1})</span>
            </div>
            <div class="small">Escanea este c√≥digo:</div>
            <img class="qr" src="${qrUrl}" alt="QR para ${playerName}" />
            <div class="small" style="margin-top:0.35rem;">
              Si el QR falla, puedes abrir este enlace manualmente:<br>
              <a href="${link}" target="_blank">${link}</a>
            </div>
          `;
          playerLinksContainer.appendChild(div);
        }

        sessionInfo.textContent =
          `ID de sesi√≥n: ${gameId} ¬∑ Jugadores: ${nPlayers} ¬∑ (La palabra se revelar√° al final)`;
        btnReveal.disabled = false;
      });

      btnReveal.addEventListener("click", () => {
        if (!currentSession) return;
        const name = currentSession.playerNames[currentSession.impostorIndex];
        alert(
          `El impostor es: ${name} (jugador #${currentSession.impostorIndex + 1})\n` +
          `Palabra secreta: ‚Äú${currentSession.word}‚Äù`
        );
      });
    }

    render();
  </script>
</body>
</html>